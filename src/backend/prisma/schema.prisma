generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

enum UserRole {
    OWNER           // God mode access to ALL
    SUPER_ADMIN     // Can manage groups and users (add, update, delete)
    MANAGER         // Can view users in the groups they belong to
    MEMBER          // Basic access own groups
}

enum GroupType {
    DEPARTMENT      // HR, IT, Marketing, etc.
    PROJECT         // Specific project teams
    FUNCTIONAL      // Cross-functional teams
    TEMPORARY       // Time-limited groups
    CUSTOM          // Custom group types
}

enum GroupVisibility {
    PUBLIC          // Visible to all users
    PRIVATE         // Only visible to members
    RESTRICTED      // Visible to specific roles
}

enum MembershipStatus {
    ACTIVE
    PENDING
    INACTIVE
    REMOVED
}

enum Permission {
    // God Mode (OWNER only)
    GOD_MODE                    // Full access to everything

    // Group Management (SUPER_ADMIN, OWNER)
    CREATE_GROUP
    DELETE_GROUP
    EDIT_GROUP
    MANAGE_GROUP_MEMBERS
    VIEW_ALL_GROUPS

    // User Management (SUPER_ADMIN, OWNER)
    MANAGE_USERS
    VIEW_ALL_USER_PROFILES
    ASSIGN_ROLES
    DELETE_USERS

    // Manager Permissions (MANAGER, SUPER_ADMIN, OWNER)
    VIEW_GROUP_MEMBERS
    MANAGE_OWN_GROUP_MEMBERS

    // Content Access (Country-based)
    VIEW_PH_RESOURCES           // Philippines resources
    VIEW_COL_RESOURCES          // Colombia resources
    VIEW_MX_RESOURCES           // Mexico resources
    VIEW_US_RESOURCES           // United States resources
    VIEW_IN_RESOURCES           // India resources

    // Department Access
    VIEW_HR_CONTENT
    VIEW_IT_CONTENT
    VIEW_FINANCE_CONTENT
    VIEW_MARKETING_CONTENT
    VIEW_SALES_CONTENT
    VIEW_DEVELOPER_CONTENT

    // System Administration (SUPER_ADMIN, OWNER)
    ADMIN_PANEL_ACCESS
    SYSTEM_SETTINGS
    ANALYTICS_ACCESS

    // AI Features (All roles)
    AI_TRAINING_ACCESS
    AI_ASSESSMENT_ACCESS
    PROMPT_TUTOR_ACCESS

    // Basic Access (All roles)
    VIEW_OWN_PROFILE
    EDIT_OWN_PROFILE
    VIEW_OWN_GROUPS
}

enum UserStatus {
    ACTIVE
    INACTIVE
    SUSPENDED
}

model User {
    id            String      @id @default(cuid())
    email         String      @unique
    name          String?
    image         String?
    role          UserRole    @default(MEMBER)
    status        UserStatus  @default(ACTIVE)
    country       String?     // Country code (PH, COL, MX, US, IN, etc.)

    // New group system
    groupMemberships    GroupMembership[]
    managedGroups       Group[]           @relation("GroupManager")
    createdGroups       Group[]           @relation("GroupCreator")

    // Activity tracking
    lastLoginAt   DateTime?
    createdAt     DateTime    @default(now())
    updatedAt     DateTime    @updatedAt

    // Analytics
    loginCount    Int         @default(0)

    // Permissions
    permissions   UserPermission[]

    @@map("users")
}



model Group {
    id              String          @id @default(cuid())
    name            String
    description     String?
    type            GroupType       @default(FUNCTIONAL)
    visibility      GroupVisibility @default(PUBLIC)

    // Group management
    managerId       String?
    manager         User?           @relation("GroupManager", fields: [managerId], references: [id])
    createdById     String
    createdBy       User            @relation("GroupCreator", fields: [createdById], references: [id])

    // Group settings
    isActive        Boolean         @default(true)
    maxMembers      Int?            // Optional member limit
    autoApprove     Boolean         @default(false) // Auto-approve join requests

    // Timestamps
    createdAt       DateTime        @default(now())
    updatedAt       DateTime        @updatedAt

    // Relations
    memberships     GroupMembership[]

    @@map("groups")
}

model GroupMembership {
    id          String           @id @default(cuid())
    userId      String
    user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
    groupId     String
    group       Group            @relation(fields: [groupId], references: [id], onDelete: Cascade)

    // Membership details
    status      MembershipStatus @default(PENDING)
    role        String?          // Custom role within the group (e.g., "Lead", "Contributor")
    joinedAt    DateTime?        // When they actually joined (approved)
    invitedBy   String?          // Who invited them

    // Permissions within this group
    canInvite   Boolean          @default(false)
    canRemove   Boolean          @default(false)
    canEdit     Boolean          @default(false)

    // Timestamps
    createdAt   DateTime         @default(now())
    updatedAt   DateTime         @updatedAt

    @@unique([userId, groupId])
    @@map("group_memberships")
}

model UserPermission {
    id          String     @id @default(cuid())
    userId      String
    user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
    permission  Permission
    resource    String?    // Optional resource identifier (e.g., group ID, content type)

    // Timestamps
    createdAt   DateTime   @default(now())
    updatedAt   DateTime   @updatedAt

    @@unique([userId, permission, resource])
    @@map("user_permissions")
}
