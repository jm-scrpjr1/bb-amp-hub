generator client {
    provider = "prisma-client-js"
    binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
    output = "/home/ubuntu/ai_workbench_clone/app/node_modules/.prisma/client"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

enum UserRole {
    OWNER
    ADMIN
    TEAM_MANAGER
    MEMBER
}

enum GroupType {
    DEPARTMENT      // HR, IT, Marketing, etc.
    PROJECT         // Specific project teams
    FUNCTIONAL      // Cross-functional teams
    TEMPORARY       // Time-limited groups
    CUSTOM          // Custom group types
}

enum GroupVisibility {
    PUBLIC          // Visible to all users
    PRIVATE         // Only visible to members
    RESTRICTED      // Visible to specific roles
}

enum MembershipStatus {
    ACTIVE
    PENDING
    INACTIVE
    REMOVED
}

enum Permission {
    // Group Management
    CREATE_GROUP
    DELETE_GROUP
    EDIT_GROUP
    MANAGE_GROUP_MEMBERS
    VIEW_ALL_GROUPS

    // User Management
    MANAGE_USERS
    VIEW_USER_PROFILES
    ASSIGN_ROLES

    // Content Access
    VIEW_HR_CONTENT
    VIEW_IT_CONTENT
    VIEW_FINANCE_CONTENT
    VIEW_MARKETING_CONTENT
    VIEW_ADMIN_CONTENT

    // System Administration
    ADMIN_PANEL_ACCESS
    SYSTEM_SETTINGS
    ANALYTICS_ACCESS

    // AI Features
    AI_TRAINING_ACCESS
    AI_ASSESSMENT_ACCESS
    PROMPT_TUTOR_ACCESS
}

enum UserStatus {
    ACTIVE
    INACTIVE
    SUSPENDED
}

model User {
    id            String      @id @default(cuid())
    email         String      @unique
    name          String?
    image         String?
    role          UserRole    @default(MEMBER)
    status        UserStatus  @default(ACTIVE)

    // Legacy team support (keeping for backward compatibility)
    teamId        String?
    team          Team?       @relation(fields: [teamId], references: [id])
    managedTeams  Team[]      @relation("TeamManager")

    // New group system
    groupMemberships    GroupMembership[]
    managedGroups       Group[]           @relation("GroupManager")
    createdGroups       Group[]           @relation("GroupCreator")

    // Activity tracking
    lastLoginAt   DateTime?
    createdAt     DateTime    @default(now())
    updatedAt     DateTime    @updatedAt

    // Analytics
    loginCount    Int         @default(0)

    // Permissions
    permissions   UserPermission[]

    @@map("users")
}

model Team {
    id          String   @id @default(cuid())
    name        String
    description String?
    managerId   String?
    manager     User?    @relation("TeamManager", fields: [managerId], references: [id])
    members     User[]

    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    @@map("teams")
}

model Group {
    id              String          @id @default(cuid())
    name            String
    description     String?
    type            GroupType       @default(FUNCTIONAL)
    visibility      GroupVisibility @default(PUBLIC)

    // Group management
    managerId       String?
    manager         User?           @relation("GroupManager", fields: [managerId], references: [id])
    createdById     String
    createdBy       User            @relation("GroupCreator", fields: [createdById], references: [id])

    // Group settings
    isActive        Boolean         @default(true)
    maxMembers      Int?            // Optional member limit
    autoApprove     Boolean         @default(false) // Auto-approve join requests

    // Relationships
    memberships     GroupMembership[]
    permissions     GroupPermission[]

    // Metadata
    tags            String[]        // For categorization and search
    metadata        Json?           // Flexible metadata storage

    createdAt       DateTime        @default(now())
    updatedAt       DateTime        @updatedAt

    @@map("groups")
}

model GroupMembership {
    id          String           @id @default(cuid())
    userId      String
    user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
    groupId     String
    group       Group            @relation(fields: [groupId], references: [id], onDelete: Cascade)

    // Membership details
    status      MembershipStatus @default(PENDING)
    role        String?          // Custom role within the group (e.g., "Lead", "Contributor")
    joinedAt    DateTime?        // When they actually joined (approved)
    invitedBy   String?          // Who invited them

    // Permissions within this group
    canInvite   Boolean          @default(false)
    canRemove   Boolean          @default(false)
    canEdit     Boolean          @default(false)

    createdAt   DateTime         @default(now())
    updatedAt   DateTime         @updatedAt

    @@unique([userId, groupId])
    @@map("group_memberships")
}

model GroupPermission {
    id          String      @id @default(cuid())
    groupId     String
    group       Group       @relation(fields: [groupId], references: [id], onDelete: Cascade)
    permission  Permission
    resource    String?     // Optional resource identifier

    createdAt   DateTime    @default(now())

    @@unique([groupId, permission, resource])
    @@map("group_permissions")
}

model UserPermission {
    id         String     @id @default(cuid())
    userId     String
    user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
    permission Permission
    resource   String?

    createdAt  DateTime   @default(now())

    @@unique([userId, permission, resource])
    @@map("user_permissions")
}

model GroupAuditLog {
    id          String      @id @default(cuid())
    groupId     String
    userId      String      // Who performed the action
    action      String      // CREATE, UPDATE, DELETE, ADD_MEMBER, REMOVE_MEMBER, etc.
    details     Json?       // Additional details about the action
    ipAddress   String?
    userAgent   String?

    createdAt   DateTime    @default(now())

    @@map("group_audit_logs")
}

model GroupInvitation {
    id          String      @id @default(cuid())
    groupId     String
    invitedEmail String
    invitedBy   String
    token       String      @unique
    expiresAt   DateTime
    acceptedAt  DateTime?

    createdAt   DateTime    @default(now())

    @@map("group_invitations")
}

model SystemAnalytics {
    id              String      @id @default(cuid())
    date            DateTime    @unique
    totalUsers      Int         @default(0)
    activeUsers     Int         @default(0)
    newUsers        Int         @default(0)
    totalLogins     Int         @default(0)
    totalGroups     Int         @default(0)
    activeGroups    Int         @default(0)

    createdAt       DateTime    @default(now())
    updatedAt       DateTime    @updatedAt

    @@map("system_analytics")
}

model SystemAnalytics {
    id              String   @id @default(cuid())
    date            DateTime @unique @default(now())
    totalUsers      Int      @default(0)
    activeUsers     Int      @default(0)
    newUsers        Int      @default(0)
    totalLogins     Int      @default(0)

    // Feature usage
    promptTutorUsage    Int @default(0)
    aiAgentsUsage       Int @default(0)
    automationsUsage    Int @default(0)
    assessmentsUsage    Int @default(0)
    resourcesUsage      Int @default(0)

    createdAt       DateTime @default(now())

    @@map("system_analytics")
}
